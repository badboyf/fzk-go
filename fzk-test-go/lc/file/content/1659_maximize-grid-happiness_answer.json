{
  "data": {
    "solutionArticle": {
      "__typename": "SolutionArticleNode",
      "author": {
        "__typename": "UserNode",
        "profile": {
          "__typename": "UserProfileNode",
          "realName": "zerotrac ğŸŒ¸",
          "userAvatar": "https://assets.leetcode-cn.com/aliyun-lc-upload/users/zerotrac2/avatar_1628749564.png",
          "userSlug": "zerotrac2"
        },
        "username": "zerotrac2"
      },
      "byLeetcode": false,
      "canEdit": false,
      "canEditReward": false,
      "canSee": true,
      "chargeType": "FREE",
      "content": "#### å‰è¨€\n\nä¸ºäº†å™è¿°æ–¹ä¾¿ï¼Œä½¿ç”¨ $\\textit{nx}$ å’Œ $\\textit{wx}$ åˆ†åˆ«è¡¨ç¤ºå†…å‘å’Œå¤–å‘çš„äººæ•°ï¼Œå¹¶ä½¿ç”¨ã€Œåˆ†æ•°ã€ä»£æ›¿ã€Œå¹¸ç¦æ„Ÿã€ã€‚\n\næœ¬é¢˜çš„æ•°æ®èŒƒå›´è¾ƒå°ï¼Œæ‰€ä»¥æ¯”è¾ƒå®¹æ˜“æƒ³åˆ°æœç´¢ + å›æº¯çš„æš´åŠ›æ–¹æ³•ã€‚ä½†æ•°æ®çœŸçš„æœ‰è¿™ä¹ˆå°å—ï¼Ÿåœ¨æœ€åæƒ…å†µä¸‹ï¼Œ$m=n=5$ å¹¶ä¸” $\\textit{nx}=\\textit{wx}=6$ï¼Œé‚£ä¹ˆåœ¨ $5\\times5=25$ ä¸ªä½ç½®ä¸­é€‰æ‹© $6$ ä¸ªåˆ†é…ç»™å†…å‘çš„äººï¼Œå†ä» $25-6=19$ ä¸ªä½ç½®ä¸­é€‰æ‹© $6$ ä¸ªåˆ†é…ç»™å¤–å‘çš„äººï¼Œé‚£ä¹ˆä½¿ç”¨ç»„åˆæ•°å¯ä»¥è®¡ç®—å‡ºä¸åŒçš„æ–¹æ¡ˆæ•°ä¸ºï¼š\n\n$$\n\\binom{25}{6} \\binom{19}{6} = 4.8 \\times 10^9\n$$\n\nå³ä½¿å¯ä»¥ $O(1)$ çš„æ—¶é—´è®¡ç®—å‡ºæ¯ä¸€ç§æ–¹æ¡ˆå¯¹åº”çš„åˆ†æ•°ï¼Œä¹Ÿä¼šå¾ˆå®¹æ˜“å¯¼è‡´è¶…å‡ºæ—¶é—´é™åˆ¶ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å‡å°‘æœç´¢ç©ºé—´ã€‚ç”±äºæ¯ä¸€ä¸ªä½ç½®åªæœ‰ã€Œç©ºã€ã€Œå†…å‘ã€ã€Œå¤–å‘ã€ä¸‰ç§çŠ¶æ€ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™ä¸‰ä¸ªçŠ¶æ€åˆ†åˆ«ç¼–ç ä¸º $0, 1, 2$ï¼Œå¹¶ç”¨ä¸€ä¸ªé•¿åº¦ï¼ˆä½æ•°ï¼‰ä¸º $n$ çš„**ä¸‰è¿›åˆ¶æ•°**å¯¹ä¸€è¡Œçš„çŠ¶æ€è¿›è¡Œç¼–ç ã€‚è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨åŸºäºçŠ¶æ€å‹ç¼©çš„åŠ¨æ€è§„åˆ’äº†ã€‚\n\n#### æ–¹æ³•ä¸€ï¼šæŒ‰è¡Œè¿›è¡ŒçŠ¶æ€å‹ç¼©\n\n**æ€è·¯ä¸ç®—æ³•**\n\nå¦‚æœæˆ‘ä»¬ä»¥ã€Œè¡Œã€ä¸ºå•ä½è¿›è¡ŒåŠ¨æ€è§„åˆ’ï¼Œé‚£ä¹ˆåœ¨è®¡ç®—åˆ†æ•°æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼š\n\n-ã€Œè¡Œå†…åˆ†æ•°ã€ï¼šåœ¨åŒä¸€è¡Œå†…æ¯ä¸ªäººçš„åˆ†æ•°ï¼Œå†…å‘ $120$ åˆ†ï¼Œå¤–å‘ $40$ åˆ†ï¼›ä»¥åŠç”±äºä¸¤äººç›¸é‚»ï¼ˆ**åœ¨åŒä¸€è¡Œå†…ï¼Œå³å·¦å³ç›¸é‚»**ï¼‰è´¡çŒ®çš„é¢å¤–åˆ†æ•°ï¼Œä¸¤ä¸ªå†…å‘ $-60$ åˆ†ï¼Œä¸¤ä¸ªå¤–å‘ $40$ åˆ†ï¼Œå…¶ä½™æƒ…å†µ $-10$ åˆ†ï¼›\n\n-ã€Œè¡Œå¤–åˆ†æ•°ã€ï¼šç”±äºä¸¤äººç›¸é‚»ï¼ˆåœ¨ä¸åŒè¡Œå†…ï¼Œå³ä¸Šä¸‹ç›¸é‚»ï¼‰è´¡çŒ®çš„é¢å¤–åˆ†æ•°ï¼ŒåŒç†ä¸º $-60,40,-10$ åˆ†ä¸­çš„ä¸€ç§ã€‚\n\næ ¹æ®ä¸Šé¢çš„æ‹†åˆ†ï¼Œ\u0008å¦‚æœæˆ‘ä»¬è§„å®šã€Œè¡Œå¤–åˆ†æ•°ã€ç”±ç›¸é‚»ä¸¤è¡Œä¸­çš„**åä¸€è¡Œ**è´Ÿè´£è®¡ç®—ï¼Œé‚£ä¹ˆåœ¨æˆ‘ä»¬æšä¸¾å½“å‰è¡Œå¯¹åº”çš„ä¸‰è¿›åˆ¶è¡¨ç¤º $\\textit{mask}$ æ—¶ï¼Œå®ƒéœ€è¦è®¡ç®—å…¶ä¸**å‰ä¸€è¡Œ**ä¹‹é—´çš„ã€Œè¡Œå¤–åˆ†æ•°ã€ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è®¾è®¡å‡ºåŠ¨æ€è§„åˆ’ä¸­çš„çŠ¶æ€ï¼š\n\n> ä»¤ $f(\\textit{mask}_L, \\textit{row}, \\textit{nx}, \\textit{wx})$ è¡¨ç¤ºå½“æˆ‘ä»¬æšä¸¾åˆ°ç¬¬ $\\textit{row}$ è¡Œä¸”ä¹‹å‰çš„è¡Œå·²ç»æšä¸¾å®Œæˆï¼Œç¬¬ $\\textit{row}-1$ è¡Œçš„çŠ¶æ€ä¸º $\\textit{mask}_L$ï¼Œè¿˜å‰©ä½™ $\\textit{nx}$ ä¸ªå†…å‘çš„äººä»¥åŠ $\\textit{wx}$ ä¸ªå¤–å‘çš„äººçš„æƒ…å†µä¸‹ï¼Œä»ç¬¬ $\\textit{row}$ è¡Œå¼€å§‹å¾€åçš„æ‰€æœ‰è¡Œå¯ä»¥è·å¾—çš„æœ€å¤§åˆ†æ•°ã€‚\n\næœ‰äº†è¿™æ ·çš„çŠ¶æ€è¡¨ç¤ºï¼Œå½“æˆ‘ä»¬åœ¨æšä¸¾ç¬¬ $\\textit{row}$ è¡Œçš„çŠ¶æ€ $\\textit{mask}$ æ—¶ï¼Œå°±å¯ä»¥å¾—åˆ°çŠ¶æ€è½¬ç§»æ–¹ç¨‹ï¼š\n\n$$\n\\begin{aligned}\n& f(\\textit{mask}_L, \\textit{row}, \\textit{nx}, \\textit{wx}) = \\max \\big\\{ \\\\\n& \\qquad f(\\textit{mask}, \\textit{row}+1, \\textit{nx}-\\text{count}_\\textit{nx}(\\textit{mask}), \\textit{wx}-\\text{count}_\\textit{wx}(\\textit{mask})) \\\\\n& \\qquad \\qquad + \\text{score}_\\textit{inner}(\\textit{mask}) \\\\\n& \\qquad \\qquad + \\text{score}_\\textit{outer}(\\textit{mask}, \\textit{mask}_L) \\\\\n& \\big\\}\n\\end{aligned}\n$$\n\nè¿™é‡Œä½¿ç”¨åˆ°çš„å‡½æ•°å¾ˆå¤šï¼Œæˆ‘ä»¬é€ä¸€è§£é‡Šï¼š\n\n- $\\text{count}_\\textit{nx}(\\textit{mask})$ è¡¨ç¤ºçŠ¶æ€ $\\textit{mask}$ ä¸­æœ‰å¤šå°‘ä¸ªå†…å‘çš„äººï¼Œå³æœ‰å¤šå°‘ä¸ª $1$ï¼›\n\n- $\\text{count}_\\textit{wx}(\\textit{mask})$ è¡¨ç¤ºçŠ¶æ€ $\\textit{mask}$ ä¸­æœ‰å¤šå°‘ä¸ªå¤–å‘çš„äººï¼Œå³æœ‰å¤šå°‘ä¸ª $2$ï¼›\n\n- $\\text{score}_\\textit{inner}(\\textit{mask})$ è¡¨ç¤ºçŠ¶æ€ $\\textit{mask}$ çš„ã€Œè¡Œå†…åˆ†æ•°ã€ï¼›\n\n- $\\text{score}_\\textit{outer}(\\textit{mask}, \\textit{mask}_L)$ è¡¨ç¤ºçŠ¶æ€ $\\textit{mask}$ å’Œ $\\textit{mask}_L$ ä¹‹é—´çš„ã€Œè¡Œå¤–åˆ†æ•°ã€ã€‚\n\nä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬æšä¸¾ç¬¬ $\\textit{row}$ è¡Œçš„çŠ¶æ€ $\\textit{mask}$ï¼Œè®¡ç®—ã€Œè¡Œå†…åˆ†æ•°ã€ä»¥åŠã€Œè¡Œå¤–åˆ†æ•°ã€ï¼Œå¹¶æ‰£é™¤è¯¥è¡Œåˆ†åˆ«ä½¿ç”¨çš„å†…å‘å’Œå¤–å‘çš„äººæ•°ï¼Œå†è½¬ç§»åˆ°ä¸‹ä¸€è¡Œã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¿…é¡»è¦ä¿è¯ä½¿ç”¨çš„å†…å‘å’Œå¤–å‘çš„äººæ•°åˆ†åˆ«ä¸èƒ½è¶…è¿‡å‰©ä½™çš„å†…å‘å’Œå¤–å‘çš„äººæ•°ã€‚\n\nç”±äºæˆ‘ä»¬ä¸å¿…ä½¿ç”¨å®Œæ‰€æœ‰çš„äººï¼Œå› æ­¤è¾¹ç•Œæ¡ä»¶å¯ä»¥æœ‰ä»¥ä¸‹ä¸¤ç§ï¼š\n\n- å½“ $\\textit{nx}=\\textit{wx}=0$ æ—¶ï¼Œå·²ç»ä½¿ç”¨å®Œäº†æ‰€æœ‰çš„äººï¼Œå¯¹åº”çš„ $f$ å€¼ä¸º $0$ï¼›\n\n- å½“ $\\textit{row}=m$ æ—¶ï¼Œå·²ç»æšä¸¾å®Œäº†æ‰€æœ‰çš„è¡Œï¼Œæ— è®º $\\textit{nx}$ å’Œ $\\textit{wx}$ çš„å€¼ä¸ºå¤šå°‘ï¼Œéƒ½æ˜¯ä¸€ç§æ»¡è¶³è¦æ±‚çš„æ–¹æ¡ˆï¼Œå¯¹åº”çš„ $f$ å€¼ä¹Ÿä¸º $0$ã€‚\n\næ­¤æ—¶ï¼Œæˆ‘ä»¬åªè¦è°ƒç”¨ $f(0, 0, \\textit{nx}, \\textit{wx})$ å¹¶ä½¿ç”¨è®°å¿†åŒ–æœç´¢çš„æ–¹æ³•å®ç°ä¸Šè¿°çŠ¶æ€è½¬ç§»æ–¹ç¨‹ï¼Œå³å¯å¾—åˆ°æœ€ç»ˆçš„ç­”æ¡ˆã€‚ä¸ºä»€ä¹ˆåˆå§‹æ—¶ $\\textit{mask}_L$ çš„å€¼ä¸º $0$ï¼Ÿæˆ‘ä»¬å¯ä»¥çœ‹æˆç¬¬ $0$ è¡Œçš„ä¸Šæ–¹æœ‰ä¸€ä¸ªã€Œè™šæ‹Ÿã€çš„ç¬¬ $-1$ è¡Œï¼Œå…¶ä¸­æ²¡æœ‰ä»»ä½•äººï¼Œå¯¹åº”çš„çŠ¶æ€è¡¨ç¤ºå³ä¸º $0$ã€‚\n\n**ç»†èŠ‚**\n\nä½¿ç”¨ä¸Šè¿°çš„çŠ¶æ€è½¬ç§»æ–¹ç¨‹ä¾¿ç¼–å†™ä»£ç å¾ˆå®¹æ˜“è¶…å‡ºæ—¶é—´é™åˆ¶ï¼Œè¿™æ˜¯å› ä¸ºè®¡ç®— $\\text{count}_\\textit{nx}(\\textit{mask})$ï¼Œ$\\text{count}_\\textit{wx}(\\textit{mask})$ï¼Œ$\\text{score}_\\textit{inner}(\\textit{mask})$ï¼Œ$\\text{score}_\\textit{outer}(\\textit{mask}, \\textit{mask}_L)$ çš„æ—¶é—´å¤æ‚åº¦å¯èƒ½è¾ƒé«˜ï¼Œå¹¶ä¸”ä¼šæ¶‰åŠåˆ°å¾ˆå¤šä¸å¿…è¦çš„é‡å¤æ“ä½œã€‚ç”±äº $\\textit{mask}$ æœ¬èº«çš„æ•°é‡æœ‰é™ï¼Œå®ƒå¯¹åº”çš„åè¿›åˆ¶å€¼åœ¨ $[0, 3^n)$ çš„èŒƒå›´å†…ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ã€Œé¢„å¤„ç†ã€å‡ºæ‰€æœ‰çš„è¿™äº›å€¼ï¼Œè€Œåœ¨çŠ¶æ€è½¬ç§»æ—¶ï¼Œå°±å¯ä»¥ $O(1)$ è®¡ç®—å‡ºç»“æœäº†ã€‚å…·ä½“å¯ä»¥å‚è€ƒä¸‹é¢ç»™å‡ºçš„ä»£ç ï¼Œé¢„å¤„ç†è®¡ç®—äº†ï¼š\n\n- æ¯ä¸€ä¸ª $\\textit{mask}$ å¯¹åº”çš„ä¸‰è¿›åˆ¶è¡¨ç¤ºï¼Œå­˜æ”¾åœ¨æ•°ç»„ $\\texttt{mask\\_span}$ ä¸­ï¼›\n\n- æ‰€æœ‰çš„ $\\text{count}_\\textit{nx}(\\textit{mask})$ å’Œ $\\text{count}_\\textit{wx}(\\textit{mask})$ï¼Œåˆ†åˆ«å­˜æ”¾åœ¨æ•°ç»„ $\\texttt{nx\\_inner}$ ä»¥åŠ $\\texttt{wx\\_inner}$ ä¸­ï¼›\n\n- æ‰€æœ‰çš„ $\\text{score}_\\textit{inner}(\\textit{mask})$ï¼Œå­˜æ”¾åœ¨æ•°ç»„ $\\texttt{score\\_inner}$ ä¸­ï¼›\n\n- æ‰€æœ‰çš„ $\\text{score}_\\textit{outer}(\\textit{mask}, \\textit{mask}_L)$ï¼Œå­˜æ”¾åœ¨æ•°ç»„ $\\texttt{score\\_outer}$ ä¸­ã€‚\n\nç”±äºæœ¬æ–¹æ³•çš„æ—¶é—´å¤æ‚åº¦è¾ƒé«˜ï¼Œä½¿ç”¨ `Python` è¾ƒéš¾é€šè¿‡ã€‚\n\n**ä»£ç **\n\n```C++ [sol1-C++]\nclass Solution {\nprivate:\n    // é¢„å¤„ç†ï¼šæ¯ä¸€ä¸ª mask çš„ä¸‰è¿›åˆ¶è¡¨ç¤º\n    int mask_span[729][6];\n    // dp[ä¸Šä¸€è¡Œçš„ mask][å½“å‰å¤„ç†åˆ°çš„è¡Œ][å‰©ä½™çš„å†…å‘äººæ•°][å‰©ä½™çš„å¤–å‘äººæ•°]\n    int dp[729][6][7][7];\n    // é¢„å¤„ç†ï¼šæ¯ä¸€ä¸ª mask åŒ…å«çš„å†…å‘äººæ•°ï¼Œå¤–å‘äººæ•°ï¼Œè¡Œå†…å¾—åˆ†ï¼ˆåªç»Ÿè®¡ mask æœ¬èº«çš„å¾—åˆ†ï¼Œä¸åŒ…æ‹¬å®ƒä¸ä¸Šä¸€è¡Œçš„ï¼‰ï¼Œè¡Œå¤–å¾—åˆ†\n    int nx_inner[729], wx_inner[729], score_inner[729], score_outer[729][729];\n    // n3 = n^3\n    int m, n, n3;\n    \npublic:\n    // å¦‚æœ x å’Œ y ç›¸é‚»ï¼Œéœ€è¦åŠ ä¸Šçš„åˆ†æ•°\n    inline int calc(int x, int y) {\n        if (x == 0 || y == 0) {\n            return 0;\n        }\n        // ä¾‹å¦‚ä¸¤ä¸ªå†…å‘çš„äººï¼Œæ¯ä¸ªäººè¦ -30ï¼Œä¸€å…± -60ï¼Œä¸‹åŒ\n        if (x == 1 && y == 1) {\n            return -60;\n        }\n        if (x == 2 && y == 2) {\n            return 40;\n        }\n        return -10;\n    }\n    \n    int getMaxGridHappiness(int m, int n, int nx, int wx) {\n        this->m = m;\n        this->n = n;\n        this->n3 = pow(3, n);\n        \n        // é¢„å¤„ç†\n        for (int mask = 0; mask < n3; ++mask) {\n            for (int mask_tmp = mask, i = 0; i < n; ++i) {\n                mask_span[mask][i] = mask_tmp % 3;\n                mask_tmp /= 3;\n            }\n            nx_inner[mask] = wx_inner[mask] = score_inner[mask] = 0;\n            for (int i = 0; i < n; ++i) {\n                if (mask_span[mask][i] != 0) {\n                    // ä¸ªäººåˆ†æ•°\n                    if (mask_span[mask][i] == 1) {\n                        ++nx_inner[mask];\n                        score_inner[mask] += 120;\n                    }\n                    else if (mask_span[mask][i] == 2) {\n                        ++wx_inner[mask];\n                        score_inner[mask] += 40;\n                    }\n                    // è¡Œå†…åˆ†æ•°\n                    if (i - 1 >= 0) {\n                        score_inner[mask] += calc(mask_span[mask][i], mask_span[mask][i - 1]);\n                    }\n                }\n            }\n        }\n        // è¡Œå¤–åˆ†æ•°\n        for (int mask0 = 0; mask0 < n3; ++mask0) {\n            for (int mask1 = 0; mask1 < n3; ++mask1) {\n                score_outer[mask0][mask1] = 0;\n                for (int i = 0; i < n; ++i) {\n                    score_outer[mask0][mask1] += calc(mask_span[mask0][i], mask_span[mask1][i]);\n                }\n            }\n        }\n        \n        memset(dp, -1, sizeof(dp));\n        return dfs(0, 0, nx, wx);\n    }\n    \n    \n    // dfs(ä¸Šä¸€è¡Œçš„ maskï¼Œå½“å‰å¤„ç†åˆ°çš„è¡Œï¼Œå‰©ä½™çš„å†…å‘äººæ•°ï¼Œå‰©ä½™çš„å¤–å‘äººæ•°ï¼‰\n    int dfs(int mask_last, int row, int nx, int wx) {\n        // è¾¹ç•Œæ¡ä»¶ï¼šå¦‚æœå·²ç»å¤„ç†å®Œï¼Œæˆ–è€…æ²¡æœ‰äººäº†\n        if (row == m || nx + wx == 0) {\n            return 0;\n        }\n        // è®°å¿†åŒ–\n        if (dp[mask_last][row][nx][wx] != -1) {\n            return dp[mask_last][row][nx][wx];\n        }\n        \n        int best = 0;\n        for (int mask = 0; mask < n3; ++mask) {\n            if (nx_inner[mask] > nx || wx_inner[mask] > wx) {\n                continue;\n            }\n            int score = score_inner[mask] + score_outer[mask][mask_last];\n            best = max(best, score + dfs(mask, row + 1, nx - nx_inner[mask], wx - wx_inner[mask]));\n        }\n        \n        return dp[mask_last][row][nx][wx] = best;\n    }\n};\n```\n\n**å¤æ‚åº¦åˆ†æ**\n\n- æ—¶é—´å¤æ‚åº¦ï¼šåˆ†ä¸ºä»¥ä¸‹éƒ¨åˆ†ï¼š\n\n    - é¢„å¤„ç†éƒ¨åˆ†è®¡ç®— $\\textit{mask}$ çš„ä¸‰è¿›åˆ¶è¡¨ç¤ºï¼Œ$\\text{count}_\\textit{nx}(\\textit{mask})$ï¼Œ$\\text{count}_\\textit{wx}(\\textit{mask})$ï¼Œ$\\text{score}_\\textit{inner}(\\textit{mask})$ çš„æ—¶é—´å¤æ‚åº¦ä¸º $O(n \\cdot 3^n)$ï¼›\n    - é¢„å¤„ç†éƒ¨åˆ†è®¡ç®— $\\text{score}_\\textit{outer}(\\textit{mask}, \\textit{mask}_L)$ çš„æ—¶é—´å¤æ‚åº¦ä¸º $O(n \\cdot 3^{2n})$ï¼›\n    - è®°å¿†åŒ–æœç´¢éƒ¨åˆ†çš„çŠ¶æ€æ€»æ•°ä¸º $O(m\\cdot\\textit{wx}\\cdot\\textit{nx}\\cdot3^n)$ï¼ŒçŠ¶æ€è½¬ç§»æ—¶éœ€è¦æšä¸¾ $O(3^n)$ çš„çŠ¶æ€ï¼Œè½¬ç§»çš„æ—¶é—´å¤æ‚åº¦ä¸º $O(1)$ï¼Œæ€»æ—¶é—´å¤æ‚åº¦ä¸º $O(m\\cdot\\textit{wx}\\cdot\\textit{nx}\\cdot3^{2n})$ã€‚\n\n    ç¬¬ä¸€é¡¹åœ¨æ¸è¿›æ„ä¹‰ä¸‹å°äºç¬¬äºŒé¡¹ï¼Œå¯ä»¥å¿½ç•¥ï¼Œå› æ­¤æ€»æ—¶é—´å¤æ‚åº¦ä¸º $O\\big((m\\cdot\\textit{wx}\\cdot\\textit{nx}+n)\\cdot3^{2n}\\big)$ã€‚\n\n- ç©ºé—´å¤æ‚åº¦ï¼šåˆ†ä¸ºä»¥ä¸‹éƒ¨åˆ†ï¼š\n\n    - é¢„å¤„ç†éƒ¨åˆ†è®¡ç®— $\\textit{mask}$ çš„ä¸‰è¿›åˆ¶è¡¨ç¤ºéœ€è¦çš„ç©ºé—´ä¸º $O(n \\cdot 3^n)$ï¼›\n    - é¢„å¤„ç†éƒ¨åˆ†è®¡ç®— $\\text{count}_\\textit{nx}(\\textit{mask})$ï¼Œ$\\text{count}_\\textit{wx}(\\textit{mask})$ï¼Œ$\\text{score}_\\textit{inner}(\\textit{mask})$ éœ€è¦çš„ç©ºé—´ä¸º $O(3^n)$ï¼›\n    - é¢„å¤„ç†éƒ¨åˆ†è®¡ç®— $\\text{score}_\\textit{outer}(\\textit{mask}, \\textit{mask}_L)$ éœ€è¦çš„ç©ºé—´ä¸º $O(3^{2n})$ï¼›\n    - è®°å¿†åŒ–æœç´¢éƒ¨åˆ†çš„çŠ¶æ€æ€»æ•°ä¸º $O(m\\cdot\\textit{wx}\\cdot\\textit{nx}\\cdot3^n)$ï¼Œå³ä¸ºéœ€è¦çš„ç©ºé—´ã€‚\n\n    è™½ç„¶æ‰€æœ‰å…¶ä½™é¡¹åœ¨æ¸è¿›æ„ä¹‰ä¸‹éƒ½å°äºç¬¬ä¸‰é¡¹ï¼Œä½†ä¸ºäº†è¡¨ç¤ºç©ºé—´ä¸æ‰€æœ‰å˜é‡ä¹‹é—´çš„å…³ç³»ï¼Œå°†æ€»ç©ºé—´å¤æ‚åº¦å†™ä¸º $O\\big((m\\cdot\\textit{wx}\\cdot\\textit{nx}+n)\\cdot3^{n} + 3^{2n}\\big)$ã€‚\n\n#### æ–¹æ³•äºŒï¼šæŒ‰è½®å»“çº¿è¿›è¡ŒçŠ¶æ€å‹ç¼©\n\n**æ€è·¯ä¸ç®—æ³•**\n\nè¿™æ˜¯ä¸€ç§åœ¨ç«èµ›ä¸­ä¼šç”¨åˆ°çš„åŠ¨æ€è§„åˆ’æ–¹æ³•ï¼Œç§°ä¹‹ä¸ºã€Œè½®å»“çº¿åŠ¨æ€è§„åˆ’ã€ã€‚å½“æˆ‘ä»¬åœ¨ä¸€ä¸ªäºŒç»´çŸ©é˜µä¸Šè¿›è¡ŒåŠ¨æ€è§„åˆ’ï¼Œå¹¶ä¸”æ•°æ®è§„æ¨¡ä¸å¤§ã€çŠ¶æ€çš„è¡¨ç¤ºæ–¹æ³•æœ‰é™ï¼ˆå¯ä»¥ä½¿ç”¨çŠ¶æ€å‹ç¼©çš„æ–¹æ³•ï¼‰ã€å¯ä»¥é€šè¿‡å½“å‰ä½ç½®ä¸å…¶ä¸Šæ–¹å’Œå·¦ä¾§çš„ä½ç½®è®¡ç®—çŠ¶æ€è½¬ç§»æ–¹ç¨‹ï¼Œé‚£ä¹ˆå°±å¯ä»¥è€ƒè™‘ä½¿ç”¨è½®å»“çº¿åŠ¨æ€è§„åˆ’ã€‚åœ¨åŠ›æ‰£å¹³å°ä¸Šï¼Œè¿™ä¸€ç±»çš„é¢˜ç›®éå¸¸å°‘ï¼Œç±»ä¼¼çš„åªæœ‰ä¸€é“åŠ›æ‰£æ¯çš„é¢˜ç›® [LCP 04. è¦†ç›–](https://leetcode-cn.com/problems/broken-board-dominoes/)ã€‚è¿™é‡Œæ„Ÿè°¢ [@newhar](/u/newhar/) æŒ‡å‡ºï¼Œè¿˜æœ‰ä¸€é“é¢˜ç›® [1349. å‚åŠ è€ƒè¯•çš„æœ€å¤§å­¦ç”Ÿæ•°](https://leetcode-cn.com/problems/maximum-students-taking-exam/)ã€‚\n\nä¸‹é¢å·¦ä¾§çš„å›¾å±•ç¤ºäº†è½®å»“çº¿åŠ¨æ€è§„åˆ’éœ€è¦ç»´æŠ¤çš„çŠ¶æ€ä»¥åŠå®ƒçš„è½¬ç§»è¿‡ç¨‹ã€‚å¦‚æœæˆ‘ä»¬æšä¸¾åˆ°äº†å½“å‰ä½ç½®ï¼ˆç»¿è‰²ï¼‰çš„çŠ¶æ€ï¼Œæˆ‘ä»¬éœ€è¦åˆ©ç”¨åˆ°**ä»è¯¥ä½ç½®ä¸Šä¸€è¡Œä½äºç›¸åŒåˆ—çš„ä½ç½®å¼€å§‹ï¼Œåˆ°è¯¥ä½ç½®çš„ä¸Šä¸€ä¸ªä½ç½®ç»“æŸ**çš„ $n$ ä¸ªçŠ¶æ€çš„çŠ¶æ€å‹ç¼©è¡¨ç¤ºï¼ˆè“è‰²ï¼‰ã€‚è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å½“å‰ä½ç½®ä¸ç¼–å·ä¸º $0$ çš„ä½ç½®ï¼ˆä¹Ÿå°±æ˜¯ä¸Šä¸‹ç›¸é‚»ï¼‰ï¼Œä»¥åŠç¼–å·ä¸º $n-1$ çš„ä½ç½®ï¼ˆå·¦å³ç›¸é‚»ï¼‰ä¹‹é—´çš„å…³ç³»ï¼Œè®¡ç®—å‡ºå› ä¸ºä¸¤äººç›¸é‚»è´¡çŒ®çš„é¢å¤–åˆ†æ•°ã€‚å¦‚æœæˆ‘ä»¬è§„å®šä¸Šä¸‹ç›¸é‚»çš„ä¸¤äººç”±ä¸‹é¢çš„äººè´Ÿè´£è®¡ç®—è´¡çŒ®ï¼Œå·¦å³ç›¸é‚»çš„äººç”±å³è¾¹çš„äººè´Ÿè´£è®¡ç®—è´¡çŒ®ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥æŒ‰ç…§è¡Œä¼˜å…ˆçš„é¡ºåºä¾æ¬¡æšä¸¾æ¯ä¸€ä¸ªä½ç½®ï¼Œå¹¶è¿›è¡ŒçŠ¶æ€è½¬ç§»äº†ã€‚\n\n<br/>\n\n![1659-0.png](https://pic.leetcode-cn.com/1605444882-ScUcVf-1659-0.png){:width=600}\n\n<br/>\n\né‚£ä¹ˆæˆ‘ä»¬ä¸ºä»€ä¹ˆè¦å­˜å‚¨è¿ç»­çš„ $n$ ä¸ªçŠ¶æ€ï¼Œè€Œä¸æ˜¯å½“å‰ä½ç½®çš„ä¸Šæ–¹å’Œå·¦ä¾§ $2$ ä¸ªçŠ¶æ€å‘¢ï¼Ÿçœ‹ä¸Šå»æˆ‘ä»¬é¢å¤–å­˜å‚¨äº† $n-2$ ä¸ªçŠ¶æ€ï¼Œä½†æˆ‘ä»¬å¯ä»¥æƒ³ä¸€ä¸‹ï¼Œå¦‚æœåªå­˜å‚¨ $2$ ä¸ªçŠ¶æ€ä¼šé€ æˆä»€ä¹ˆåæœã€‚å‚è€ƒä¸Šé¢å³ä¾§çš„å›¾ï¼Œå½“æˆ‘ä»¬æšä¸¾åˆ°ä¸‹ä¸€ä¸ªä½ç½®æ—¶ï¼Œå¦‚æœæˆ‘ä»¬å­˜å‚¨çš„æ˜¯è¿ç»­çš„ $n$ ä¸ªçŠ¶æ€ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†ä¸Šé¢å·¦ä¾§ç¼–å· $0$ çš„ä½ç½®ç§»é™¤ï¼Œå†æ·»åŠ å‰ä¸€ä¸ªä½ç½®ï¼Œå°±å¯ä»¥å¾—åˆ°ä¸‹ä¸€ä¸ªä½ç½®å¯¹åº”çš„ $n$ ä¸ªçŠ¶æ€ã€‚ä½†åŠ å…¥æˆ‘ä»¬åªå­˜å‚¨çŠ¶æ€ $0$ å’Œ $n-1$ï¼Œé‚£ä¹ˆåœ¨æšä¸¾åˆ°ä¸‹ä¸€ä¸ªä½ç½®æ—¶ï¼ŒçŠ¶æ€ $n-1$ å¯ä»¥é€šè¿‡ä¸Šä¸€ä¸ªä½ç½®å¾—åˆ°ï¼Œä½†çŠ¶æ€ $0$ å´æ˜¯æœªçŸ¥çš„äº†ã€‚è¿™ä¹Ÿæ˜¯è½®å»“çº¿åŠ¨æ€è§„åˆ’çš„å¦™å¤„æ‰€åœ¨ã€‚\n\nå› æ­¤æˆ‘ä»¬å¯ä»¥è®¾è®¡å‡ºåŠ¨æ€è§„åˆ’ä¸­çš„çŠ¶æ€ï¼š\n\n> ä»¤ $f(\\textit{pos}, \\textit{borderline}, \\textit{nx}, \\textit{wx})$ è¡¨ç¤ºå½“æˆ‘ä»¬æšä¸¾åˆ°ç¬¬ $\\textit{pos}$ ä¸ªä½ç½®ä¸”ä¹‹å‰çš„ä½ç½®å·²ç»æšä¸¾å®Œæˆï¼Œè¯¥ä½ç½®çš„å‰ $n$ ä¸ªä½ç½®çš„çŠ¶æ€å‹ç¼©ä¸º $\\textit{borderline}$ï¼Œè¿˜å‰©ä½™ $\\textit{nx}$ ä¸ªå†…å‘çš„äººä»¥åŠ $\\textit{wx}$ ä¸ªå¤–å‘çš„äººçš„æƒ…å†µä¸‹ï¼Œä»ç¬¬ $\\textit{pos}$ ä¸ªä½ç½®å¼€å§‹å¾€åçš„æ‰€æœ‰ä½ç½®å¯ä»¥è·å¾—çš„æœ€å¤§åˆ†æ•°ã€‚\n\næœ‰äº†è¿™æ ·çš„çŠ¶æ€è¡¨ç¤ºï¼Œå½“æˆ‘ä»¬åœ¨æšä¸¾ç¬¬ $\\textit{pos}$ ä¸ªä½ç½®çš„çŠ¶æ€æ—¶ï¼Œè€ƒè™‘ä¸‰ç§æƒ…å†µï¼š\n\n- ç¬¬ $\\textit{pos}$ ä¸ªä½ç½®ä¸ºã€Œç©ºã€ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç›´æ¥è¿›è¡ŒçŠ¶æ€è½¬ç§»ï¼š\n\n    $$\n    f(\\textit{pos}, \\textit{borderline}, \\textit{nx}, \\textit{wx}) = f(\\textit{pos}+1, \\textit{borderline}\\backslash0, \\textit{nx}, \\textit{wx})\n    $$\n\n    è¿™é‡Œ $\\textit{borderline}\\backslash0$ è¡¨ç¤ºå°† $\\textit{borderline}$ æœ€å‰é¢çš„ç¬¬ $0$ ä¸ªä½ç½®ç§»é™¤ï¼Œå†åœ¨æœ€åé¢æ·»åŠ çŠ¶æ€ $0$ å¾—åˆ°çš„ç»“æœã€‚å®ƒçš„è®¡ç®—æ–¹æ³•å¾ˆç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦å°† $\\textit{borderline}$ çš„**æœ€é«˜ä½**ç§»é™¤ï¼Œå‰©ä½™éƒ¨åˆ†ä¹˜ $3$ï¼Œå†åŠ ä¸Š $0$ å³å¯ï¼Œå³ï¼š\n\n    $$\n    \\textit{borderline}\\backslash0 = \\textit{borderline} ~\\%~ 3^{n-1} \\times 3 + 0\n    $$\n\n    å…¶ä¸­ $\\%$ è¡¨ç¤ºå–æ¨¡è¿ç®—ã€‚ä¸‹é¢çš„çŠ¶æ€è½¬ç§»ä¸­ä¼šä½¿ç”¨åˆ° $\\textit{borderline}\\backslash1$ ä»¥åŠ $\\textit{borderline}\\backslash2$ï¼Œè®¡ç®—æ–¹æ³•ç›¸åŒã€‚\n\n- ç¬¬ $\\textit{pos}$ ä¸ªä½ç½®ä¸ºã€Œå†…å‘ã€ï¼Œæˆ‘ä»¬éœ€è¦å¢åŠ å†…å‘çš„åˆ†æ•° $120$ï¼Œå¹¶ä¸”è®¡ç®—å…¶ä¸ä¸¤ä¸ªç›¸é‚»ä½ç½®ï¼ˆä¸Šæ–¹ä»¥åŠå·¦ä¾§ï¼‰çš„é¢å¤–åˆ†æ•°ã€‚åœ¨è½¬ç§»ä¹‹å‰ï¼Œéœ€è¦ä¿è¯ $\\textit{nx}$ ä¸ä¸º $0$ï¼š\n\n    $$\n    \\begin{aligned}\n    f(\\textit{pos}, \\textit{borderline}, \\textit{nx}, \\textit{wx}) = 120 &+ \\text{calc}(1, \\textit{borderline}[0]) \\\\\n    &+ \\text{calc}(1, \\textit{borderline}[n-1]) \\\\\n    &+ f(\\textit{pos}+1, \\textit{borderline}\\backslash1, \\textit{nx}-1, \\textit{wx})\n    \\end{aligned}\n    $$\n\n    å…¶ä¸­å‡½æ•° $\\text{calc}(x, y)$ è¡¨ç¤ºä¸¤ä¸ªç›¸é‚»ä½ç½®çš„çŠ¶æ€åˆ†åˆ«ä¸º $x$ å’Œ $y$ æ—¶çš„é¢å¤–åˆ†æ•°ï¼Œå½“æ–¹æ³•ä¸€ä¸­ä¹Ÿä½¿ç”¨åˆ°äº†ç±»ä¼¼çš„å‡½æ•°ï¼šå…¶ä¸­æœ‰ä¸€ä¸ªä¸º $0$ è®° $0$ åˆ†ï¼Œå‡ä¸º $1$ è®° $-60$ åˆ†ï¼Œå‡ä¸º $2$ è®° $40$ åˆ†ï¼Œå…¶ä½™æƒ…å†µè®° $-10$ åˆ†ã€‚\n\n- ç¬¬ $\\textit{pos}$ ä¸ªä½ç½®ä¸ºã€Œå¤–å‘ã€ï¼Œæˆ‘ä»¬éœ€è¦å¢åŠ å¤–å‘çš„åˆ†æ•° $40$ï¼Œå¹¶ä¸”è®¡ç®—å…¶ä¸ä¸¤ä¸ªç›¸é‚»ä½ç½®ï¼ˆä¸Šæ–¹ä»¥åŠå·¦ä¾§ï¼‰çš„é¢å¤–åˆ†æ•°ã€‚åœ¨è½¬ç§»ä¹‹å‰ï¼Œéœ€è¦ä¿è¯ $\\textit{wx}$ ä¸ä¸º $0$ï¼š\n\n    $$\n    \\begin{aligned}\n    f(\\textit{pos}, \\textit{borderline}, \\textit{nx}, \\textit{wx}) = 40 &+ \\text{calc}(2, \\textit{borderline}[0]) \\\\\n    &+ \\text{calc}(2, \\textit{borderline}[n-1]) \\\\\n    &+ f(\\textit{pos}+1, \\textit{borderline}\\backslash2, \\textit{nx}, \\textit{wx}-1)\n    \\end{aligned}\n    $$\n\nä¸æ–¹æ³•ä¸€ç±»ä¼¼ï¼Œè¾¹ç•Œæ¡ä»¶æœ‰ä¸¤ç§ï¼š\n\n- å½“ $\\textit{nx}=\\textit{wx}=0$ æ—¶ï¼Œå·²ç»ä½¿ç”¨å®Œäº†æ‰€æœ‰çš„äººï¼Œå¯¹åº”çš„ $f$ å€¼ä¸º $0$ï¼›\n\n- å½“ $\\textit{pos}=mn$ æ—¶ï¼Œå·²ç»æšä¸¾å®Œäº†æ‰€æœ‰çš„ä½ç½®ï¼Œæ— è®º $\\textit{nx}$ å’Œ $\\textit{wx}$ çš„å€¼ä¸ºå¤šå°‘ï¼Œéƒ½æ˜¯ä¸€ç§æ»¡è¶³è¦æ±‚çš„æ–¹æ¡ˆï¼Œå¯¹åº”çš„ $f$ å€¼ä¹Ÿä¸º $0$ã€‚\n\n**ç»†èŠ‚**\n\næ–¹æ³•äºŒä¸­çš„ç»†èŠ‚æ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬é€ä¸€è¿›è¡Œåˆ†æã€‚\n\né¦–å…ˆæ˜¯çŠ¶æ€è½¬ç§»æ—¶çš„ç‰¹æ®Šæƒ…å†µã€‚è€ƒè™‘ä¸‹é¢å·¦ä¾§çš„å›¾ï¼Œè‹¥å½“å‰æšä¸¾åˆ°çš„ä½ç½®ä½äºé¦–åˆ—ï¼Œé‚£ä¹ˆå®ƒæ˜¯æ²¡æœ‰å·¦ä¾§ç›¸é‚»ä½ç½®çš„ï¼Œå³å®ƒä¸å­˜å‚¨çš„ç¬¬ $n-1$ ä¸ªçŠ¶æ€å¹¶ä¸ç›¸é‚»ï¼Œå› æ­¤çŠ¶æ€è½¬ç§»æ–¹ç¨‹ä¸­å¯¹åº”çš„ $\\text{calc}(1, \\textit{borderline}[n-1])$ ä»¥åŠ $\\text{calc}(2, \\textit{borderline}[n-1])$ é¡¹ä¸èƒ½å¸¦å…¥è®¡ç®—ã€‚\n\nå†è€ƒè™‘ä¸‹é¢å³ä¾§çš„å›¾ï¼Œè‹¥å½“å‰æšä¸¾åˆ°çš„ä½ç½®ä½äºé¦–è¡Œï¼Œé‚£ä¹ˆå®ƒæ˜¯æ²¡æœ‰ä¸Šæ–¹ç›¸é‚»ä½ç½®çš„ï¼Œä½†æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸æ–¹æ³•ä¸€ä¸­ç›¸åŒçš„å¤„ç†å½¢å¼ï¼Œçœ‹æˆå…¶ä¸Šæ–¹æœ‰ä¸€ä¸ªã€Œè™šæ‹Ÿã€çš„ç¬¬ $-1$ è¡Œï¼Œè¯¥è¡Œçš„æ‰€æœ‰çŠ¶æ€å‡ä¸º $0$ã€‚è¿™ä¹Ÿå‘Šè¯‰äº†æˆ‘ä»¬å¦‚æœä½¿ç”¨è®°å¿†åŒ–æœç´¢çš„æ–¹æ³•å®ç°æ–¹æ³•äºŒï¼Œé‚£ä¹ˆåªéœ€è¦è°ƒç”¨ $f(0, 0, \\textit{nx}, \\textit{wx})$ å³å¯å¾—åˆ°æœ€ç»ˆçš„ç­”æ¡ˆï¼Œè¿™é‡Œç¬¬äºŒä¸ªå‚æ•°ä¸­çš„ $0$ å°±è¡¨ç¤ºè™šæ‹Ÿè¡ŒåŒ…å« $n$ ä¸ª $0$ã€‚\n\n<br/>\n\n![1659-1.png](https://pic.leetcode-cn.com/1605444988-NtjNmx-1659-1.png){:width=600}\n\n<br/>\n\næ­¤å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é¢„å¤„ç†å‡ºä¸€äº›ç»“æœï¼Œä½¿å¾—å¯ä»¥ $O(1)$ çš„æ—¶é—´è¿›è¡ŒçŠ¶æ€è½¬ç§»ï¼š\n\n- æ¯ä¸€ä¸ª $\\textit{mask}$ å¯¹åº”çš„ä¸‰è¿›åˆ¶è¡¨ç¤ºï¼Œå­˜æ”¾åœ¨æ•°ç»„ $\\texttt{mask\\_span}$ ä¸­ã€‚æ³¨æ„ç”±äºæˆ‘ä»¬åœ¨è¿›è¡Œåè¿›åˆ¶è½¬ä¸‰è¿›åˆ¶æ—¶ï¼Œé¦–å…ˆå¾—åˆ°çš„æ˜¯ä½ä½ï¼Œè€Œåœ¨æ–¹æ³•äºŒçš„çŠ¶æ€è¡¨ç¤ºä¸­ï¼Œä½ä½çš„ç¼–å·åè€Œæ›´å¤§ï¼ˆæœ€ä½ä½ç¼–å·ä¸º $n-1$ï¼Œæœ€é«˜ä½ç¼–å·ä¸º $0$ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬è¦éœ€è¦æ³¨æ„å°†ä¸‰è¿›åˆ¶è¡¨ç¤ºä»¥æ­£ç¡®çš„é¡ºåºè¿›è¡Œå­˜å‚¨ï¼›\n\n- æ‰€æœ‰çš„ $\\textit{mask}\\backslash0$ï¼Œ$\\textit{mask}\\backslash1$ï¼Œ$\\textit{mask}\\backslash2$ï¼Œå­˜æ”¾åœ¨æ•°ç»„ $\\texttt{truncate}$ ä¸­ã€‚\n\n**ä»£ç **\n\n```C++ [sol2-C++]\nclass Solution {\nprivate:\n    // é¢„å¤„ç†ï¼šæ¯ä¸€ä¸ª mask çš„ä¸‰è¿›åˆ¶è¡¨ç¤º\n    int mask_span[729][6];\n    // dp[ä½ç½®][è½®å»“çº¿ä¸Šçš„ mask][å‰©ä½™çš„å†…å‘äººæ•°][å‰©ä½™çš„å¤–å‘äººæ•°]\n    int dp[25][729][7][7];\n    // é¢„å¤„ç†ï¼šæ¯ä¸€ä¸ª mask å»é™¤æœ€é«˜ä½ã€ä¹˜ 3ã€åŠ ä¸Šæ–°çš„æœ€ä½ä½çš„ç»“æœ\n    int truncate[729][3];\n    // n3 = n^3\n    int m, n, n3;\n    \npublic:\n    // å¦‚æœ x å’Œ y ç›¸é‚»ï¼Œéœ€è¦åŠ ä¸Šçš„åˆ†æ•°\n    inline int calc(int x, int y) {\n        if (x == 0 || y == 0) {\n            return 0;\n        }\n        // ä¾‹å¦‚ä¸¤ä¸ªå†…å‘çš„äººï¼Œæ¯ä¸ªäººè¦ -30ï¼Œä¸€å…± -60ï¼Œä¸‹åŒ\n        if (x == 1 && y == 1) {\n            return -60;\n        }\n        if (x == 2 && y == 2) {\n            return 40;\n        }\n        return -10;\n    }\n    \n    int getMaxGridHappiness(int m, int n, int nx, int wx) {\n        this->m = m;\n        this->n = n;\n        this->n3 = pow(3, n);\n        \n        // é¢„å¤„ç†\n        int highest = this->n3 / 3;\n        for (int mask = 0; mask < n3; ++mask) {\n            for (int mask_tmp = mask, i = 0; i < n; ++i) {\n                // ä¸æ–¹æ³•ä¸€ä¸åŒçš„æ˜¯ï¼Œè¿™é‡Œéœ€è¦åè¿‡æ¥å­˜å‚¨ï¼Œè¿™æ · [0] å¯¹åº”æœ€é«˜ä½ï¼Œ[n-1] å¯¹åº”æœ€ä½ä½\n                mask_span[mask][n - i - 1] = mask_tmp % 3;\n                mask_tmp /= 3;\n            }\n            truncate[mask][0] = mask % highest * 3;\n            truncate[mask][1] = mask % highest * 3 + 1;\n            truncate[mask][2] = mask % highest * 3 + 2;\n        }\n        \n        memset(dp, -1, sizeof(dp));\n        return dfs(0, 0, nx, wx);\n    }\n    \n    \n    // dfs(ä½ç½®ï¼Œè½®å»“çº¿ä¸Šçš„ maskï¼Œå‰©ä½™çš„å†…å‘äººæ•°ï¼Œå‰©ä½™çš„å¤–å‘äººæ•°)\n    int dfs(int pos, int borderline, int nx, int wx) {\n        // è¾¹ç•Œæ¡ä»¶ï¼šå¦‚æœå·²ç»å¤„ç†å®Œï¼Œæˆ–è€…æ²¡æœ‰äººäº†\n        if (pos == m * n || nx + wx == 0) {\n            return 0;\n        }\n        // è®°å¿†åŒ–\n        if (dp[pos][borderline][nx][wx] != -1) {\n            return dp[pos][borderline][nx][wx];\n        }\n        \n        int x = pos / n, y = pos % n;\n        \n        // ä»€ä¹ˆéƒ½ä¸åš\n        int best = dfs(pos + 1, truncate[borderline][0], nx, wx);\n        // æ”¾ä¸€ä¸ªå†…å‘çš„äºº\n        if (nx > 0) {\n            best = max(best, 120 + calc(1, mask_span[borderline][0]) \\\n                                 + (y == 0 ? 0 : calc(1, mask_span[borderline][n - 1])) \\\n                                 + dfs(pos + 1, truncate[borderline][1], nx - 1, wx));\n        }\n        // æ”¾ä¸€ä¸ªå¤–å‘çš„äºº\n        if (wx > 0) {\n            best = max(best, 40 + calc(2, mask_span[borderline][0]) \\\n                                + (y == 0 ? 0 : calc(2, mask_span[borderline][n - 1])) \\\n                                + dfs(pos + 1, truncate[borderline][2], nx, wx - 1));\n        }\n\n        return dp[pos][borderline][nx][wx] = best;\n    }\n};\n```\n\n```Python [sol2-Python3]\nclass Solution:\n    def getMaxGridHappiness(self, m: int, n: int, nx: int, wx: int) -> int:\n        # å¦‚æœ x å’Œ y ç›¸é‚»ï¼Œéœ€è¦åŠ ä¸Šçš„åˆ†æ•°\n        def calc(x: int, y: int) -> int:\n            if x == 0 or y == 0:\n                return 0\n            # ä¾‹å¦‚ä¸¤ä¸ªå†…å‘çš„äººï¼Œæ¯ä¸ªäººè¦ -30ï¼Œä¸€å…± -60ï¼Œä¸‹åŒ\n            if x == 1 and y == 1:\n                return -60\n            if x == 2 and y == 2:\n                return 40\n            return -10\n        \n        n3 = 3**n\n        # é¢„å¤„ç†ï¼šæ¯ä¸€ä¸ª mask çš„ä¸‰è¿›åˆ¶è¡¨ç¤º\n        mask_span = dict()\n        # é¢„å¤„ç†ï¼šæ¯ä¸€ä¸ª mask å»é™¤æœ€é«˜ä½ã€ä¹˜ 3ã€åŠ ä¸Šæ–°çš„æœ€ä½ä½çš„ç»“æœ\n        truncate = dict()\n\n        # é¢„å¤„ç†\n        highest = n3 // 3\n        for mask in range(n3):\n            mask_tmp = mask\n            bits = list()\n            for i in range(n):\n                bits.append(mask_tmp % 3)\n                mask_tmp //= 3\n            # ä¸æ–¹æ³•ä¸€ä¸åŒçš„æ˜¯ï¼Œè¿™é‡Œéœ€è¦åè¿‡æ¥å­˜å‚¨ï¼Œè¿™æ · [0] å¯¹åº”æœ€é«˜ä½ï¼Œ[n-1] å¯¹åº”æœ€ä½ä½\n            mask_span[mask] = bits[::-1]\n            truncate[mask] = [\n                mask % highest * 3,\n                mask % highest * 3 + 1,\n                mask % highest * 3 + 2,\n            ]\n        \n        # dfs(ä½ç½®ï¼Œè½®å»“çº¿ä¸Šçš„ maskï¼Œå‰©ä½™çš„å†…å‘äººæ•°ï¼Œå‰©ä½™çš„å¤–å‘äººæ•°)\n        @lru_cache(None)\n        def dfs(pos: int, borderline: int, nx: int, wx: int):\n            # è¾¹ç•Œæ¡ä»¶ï¼šå¦‚æœå·²ç»å¤„ç†å®Œï¼Œæˆ–è€…æ²¡æœ‰äººäº†\n            if pos == m * n or nx + wx == 0:\n                return 0\n            \n            x, y = divmod(pos, n)\n            \n            # ä»€ä¹ˆéƒ½ä¸åš\n            best = dfs(pos + 1, truncate[borderline][0], nx, wx)\n            # æ”¾ä¸€ä¸ªå†…å‘çš„äºº\n            if nx > 0:\n                best = max(best, 120 + calc(1, mask_span[borderline][0]) \\\n                                     + (0 if y == 0 else calc(1, mask_span[borderline][n - 1])) \\\n                                     + dfs(pos + 1, truncate[borderline][1], nx - 1, wx))\n            # æ”¾ä¸€ä¸ªå¤–å‘çš„äºº\n            if wx > 0:\n                best = max(best, 40 + calc(2, mask_span[borderline][0]) \\\n                                    + (0 if y == 0 else calc(2, mask_span[borderline][n - 1])) \\\n                                    + dfs(pos + 1, truncate[borderline][2], nx, wx - 1))\n\n            return best\n        \n        return dfs(0, 0, nx, wx)\n```\n\n**å¤æ‚åº¦åˆ†æ**\n\n\n- æ—¶é—´å¤æ‚åº¦ï¼šåˆ†ä¸ºä»¥ä¸‹éƒ¨åˆ†ï¼š\n\n    - é¢„å¤„ç†éƒ¨åˆ†è®¡ç®— $\\textit{mask}$ çš„ä¸‰è¿›åˆ¶è¡¨ç¤ºï¼Œ$\\textit{mask}\\backslash0$ï¼Œ$\\textit{mask}\\backslash1$ï¼Œ$\\textit{mask}\\backslash2$ çš„æ—¶é—´å¤æ‚åº¦ä¸º $O(n \\cdot 3^n)$ï¼›\n    - è®°å¿†åŒ–æœç´¢éƒ¨åˆ†çš„çŠ¶æ€æ€»æ•°ä¸º $O(m\\cdot n\\cdot\\textit{wx}\\cdot\\textit{nx}\\cdot3^n)$ï¼ŒçŠ¶æ€è½¬ç§»æ—¶éœ€è¦æšä¸¾ $3=O(1)$ ä¸ªçŠ¶æ€ï¼Œè½¬ç§»çš„æ—¶é—´å¤æ‚åº¦ä¸º $O(1)$ï¼Œæ€»æ—¶é—´å¤æ‚åº¦ä¸º $O(m\\cdot n\\cdot\\textit{wx}\\cdot\\textit{nx}\\cdot3^n)$ã€‚\n\n    ç¬¬ä¸€é¡¹åœ¨æ¸è¿›æ„ä¹‰ä¸‹å°äºç¬¬äºŒé¡¹ï¼Œå¯ä»¥å¿½ç•¥ï¼Œå› æ­¤æ€»æ—¶é—´å¤æ‚åº¦ä¸º $O(m\\cdot n\\cdot\\textit{wx}\\cdot\\textit{nx}\\cdot3^n)$ã€‚\n\n- ç©ºé—´å¤æ‚åº¦ï¼šåˆ†ä¸ºä»¥ä¸‹éƒ¨åˆ†ï¼š\n\n    - é¢„å¤„ç†éƒ¨åˆ†è®¡ç®— $\\textit{mask}$ çš„ä¸‰è¿›åˆ¶è¡¨ç¤ºéœ€è¦çš„ç©ºé—´ä¸º $O(n \\cdot 3^n)$ï¼›\n    - é¢„å¤„ç†éƒ¨åˆ†è®¡ç®— $\\textit{mask}\\backslash0$ï¼Œ$\\textit{mask}\\backslash1$ï¼Œ$\\textit{mask}\\backslash2$ éœ€è¦çš„ç©ºé—´ä¸º $O(3^n)$ï¼›\n    - è®°å¿†åŒ–æœç´¢éƒ¨åˆ†çš„çŠ¶æ€æ€»æ•°ä¸º $O(m\\cdot n\\cdot\\textit{wx}\\cdot\\textit{nx}\\cdot3^n)$ï¼Œå³ä¸ºéœ€è¦çš„ç©ºé—´ã€‚\n\n    ç¬¬ä¸€é¡¹å’Œç¬¬äºŒé¡¹åœ¨æ¸è¿›æ„ä¹‰ä¸‹éƒ½å°äºç¬¬ä¸‰é¡¹ï¼Œå¯ä»¥å¿½ç•¥ï¼Œå› æ­¤æ€»ç©ºé—´å¤æ‚åº¦å†™ä¸º $O(m\\cdot n\\cdot\\textit{wx}\\cdot\\textit{nx}\\cdot3^n)$ã€‚",
      "createdAt": "2020-11-15T04:27:17.070707+00:00",
      "hitCount": 4592,
      "identifier": "33tMXv",
      "isEditorsPick": false,
      "isMostPopular": false,
      "isMyFavorite": false,
      "next": {
        "__typename": "BriefSolutionNode",
        "slug": "you-yi-chong-zhuang-ya-jiao-zuo-hua-dong-chuang-ko",
        "title": "æœ‰ä¸€ç§çŠ¶å‹ï¼Œå«åšæ»‘åŠ¨çª—å£çŠ¶å‹ï¼ˆ112msï¼‰"
      },
      "position": 1,
      "prev": null,
      "question": {
        "__typename": "QuestionNode",
        "questionTitleSlug": "maximize-grid-happiness"
      },
      "reactionType": null,
      "reactionsV2": [
        {
          "__typename": "ReactionCountNode",
          "count": 50,
          "reactionType": "UPVOTE"
        },
        {
          "__typename": "ReactionCountNode",
          "count": 8,
          "reactionType": "AWESOME"
        }
      ],
      "rewardEnabled": null,
      "slug": "zui-da-hua-wang-ge-xing-fu-gan-by-zerotrac2",
      "status": "PUBLISHED",
      "summary": "å‰è¨€\nä¸ºäº†å™è¿°æ–¹ä¾¿ï¼Œä½¿ç”¨ \\textit{nx} å’Œ \\textit{wx} åˆ†åˆ«è¡¨ç¤ºå†…å‘å’Œå¤–å‘çš„äººæ•°ï¼Œå¹¶ä½¿ç”¨ã€Œåˆ†æ•°ã€ä»£æ›¿ã€Œå¹¸ç¦æ„Ÿã€ã€‚\næœ¬é¢˜çš„æ•°æ®èŒƒå›´è¾ƒå°ï¼Œæ‰€ä»¥æ¯”è¾ƒå®¹æ˜“æƒ³åˆ°æœç´¢ + å›æº¯çš„æš´åŠ›æ–¹æ³•ã€‚ä½†æ•°æ®çœŸçš„æœ‰è¿™ä¹ˆå°å—ï¼Ÿåœ¨æœ€åæƒ…å†µä¸‹ï¼Œm=n=5 å¹¶ä¸” \\textit{nx}=\\textit{wx}=6ï¼Œé‚£ä¹ˆåœ¨ 5\\t",
      "sunk": false,
      "tags": [
        {
          "__typename": "CommonTagNode",
          "name": "Bit Manipulation",
          "nameTranslated": "ä½è¿ç®—",
          "slug": "bit-manipulation",
          "tagType": "TOPIC"
        },
        {
          "__typename": "CommonTagNode",
          "name": "Memoization",
          "nameTranslated": "è®°å¿†åŒ–æœç´¢",
          "slug": "memoization",
          "tagType": "TOPIC"
        },
        {
          "__typename": "CommonTagNode",
          "name": "Dynamic Programming",
          "nameTranslated": "åŠ¨æ€è§„åˆ’",
          "slug": "dynamic-programming",
          "tagType": "TOPIC"
        },
        {
          "__typename": "CommonTagNode",
          "name": "C++",
          "nameTranslated": "",
          "slug": "cpp",
          "tagType": "LANGUAGE"
        }
      ],
      "thumbnail": "https://pic.leetcode-cn.com/1605444882-ScUcVf-1659-0.png",
      "title": "æœ€å¤§åŒ–ç½‘æ ¼å¹¸ç¦æ„Ÿ",
      "topic": {
        "__typename": "TopicNode",
        "commentCount": 25,
        "id": 485292,
        "viewCount": 3063
      },
      "uuid": "33tMXv",
      "videosInfo": []
    }
  }
}
